name: Report Test Results to Zephyr

on:
  workflow_run:
    workflows: ["Storybook Tests"]
    types: [completed]

permissions:
  contents: read
  actions: read

jobs:
  report:
    # Only run if the triggering workflow succeeded or failed (not cancelled)
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: "20"
          cache: "yarn"

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: yarn install --immutable

      - name: Download test results artifact
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: storybook-junit-results
          path: test-results/
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}

      - name: Report results to Zephyr
        env:
          ZEPHYR_TOKEN: ${{ secrets.ZEPHYR_TOKEN }}
          JUNIT_PATH: test-results/storybook-junit.xml
          ZEPHYR_CYCLE_NAME_PREFIX: "Storybook CI Run #${{ github.event.workflow_run.run_number }}"
        run: npx tsx scripts/zephyr/report-zephyr-results.ts

