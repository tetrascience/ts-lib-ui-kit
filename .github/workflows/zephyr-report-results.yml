name: Report Test Results to Zephyr

# This workflow reports Storybook test results to Zephyr Scale.
# - Automatic (workflow_run): Uses persistent cycle for main, or find-or-create for feature branches
# - Manual (workflow_dispatch): Reports to an existing test cycle you specify

on:
  workflow_run:
    workflows: ['Storybook Tests']
    types: [completed]
  workflow_dispatch:
    inputs:
      test_cycle:
        description: 'Zephyr test cycle key to report results to (e.g., SW-R123)'
        required: true
        type: string
      run_id:
        description: 'Workflow run ID to download artifacts from'
        required: true
        type: string

permissions:
  contents: read
  actions: read

jobs:
  report:
    # Run on workflow_run (when Storybook Tests completes) or workflow_dispatch (manual)
    if: >
      github.event_name == 'workflow_dispatch' ||
      github.event.workflow_run.conclusion == 'success' ||
      github.event.workflow_run.conclusion == 'failure'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          # Checkout the same commit that triggered the Storybook Tests workflow
          # This ensures we parse story files from the correct branch to get Zephyr IDs
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: '20'
          cache: 'yarn'

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: yarn install --immutable

      - name: Download test results artifact
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: storybook-junit-results
          path: test-results/
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ inputs.run_id || github.event.workflow_run.id }}

      # Restore cached cycle key for feature branches (not main, not workflow_dispatch)
      - name: Restore cached cycle key
        if: github.event_name == 'workflow_run' && github.event.workflow_run.head_branch != 'main'
        id: cache-cycle
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
        with:
          path: .zephyr-cycle-key
          key: zephyr-cycle-${{ github.event.workflow_run.head_branch }}

      # Report test results to Zephyr Scale
      # - main branch or workflow_dispatch: Uses provided/hardcoded cycle key
      # - feature branches: Find-or-create cycle, cached per branch
      - name: Report results to Zephyr
        env:
          ZEPHYR_TOKEN: ${{ secrets.ZEPHYR_TOKEN }}
          ZEPHYR_BRANCH: ${{ github.event.workflow_run.head_branch || '' }}
          ZEPHYR_CYCLE_KEY: ${{ inputs.test_cycle || (github.event.workflow_run.head_branch == 'main' && 'SW-R33') || '' }}
          ZEPHYR_CYCLE_CACHE_FILE: .zephyr-cycle-key
          JUNIT_PATH: test-results/storybook-junit.xml
          # For workflow_run, link to the triggering workflow; for workflow_dispatch, link to the specified run
          GITHUB_ACTIONS_URL: ${{ github.event.workflow_run.html_url || format('{0}/{1}/actions/runs/{2}', github.server_url, github.repository, inputs.run_id) }}
        run: npx tsx scripts/zephyr/report-zephyr-results.ts

      # Save cycle key to cache for feature branches (after script creates it)
      - name: Save cycle key to cache
        if: github.event_name == 'workflow_run' && github.event.workflow_run.head_branch != 'main' && steps.cache-cycle.outputs.cache-hit != 'true'
        uses: actions/cache/save@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
        with:
          path: .zephyr-cycle-key
          key: zephyr-cycle-${{ github.event.workflow_run.head_branch }}
